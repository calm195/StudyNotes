# 过期淘汰策略

## 过期删除策略

Redis可以对key设置过期时间，需要有相应的机制删除过期的键值对，即为过期删除策略。

- 过期字典
  每当一个key设置了过期时间，就会被添加到过期字典中

  > ```c
  > struct redisDb {
  >     dict *dict; // 数据字典
  >     dict *expires; // 过期字典
  > };
  > ```

  - 过期字典的key是一个指针，指向某个对象；value是一个long long类型的整数，表示过期时间的毫秒时间戳。

- 过期删除策略
  - 定时删除：每隔一段时间，遍历过期字典，删除过期的键值对
    - 优点：保证过期的键值对能够及时删除，内存能够及时释放
    - 缺点：可能会阻塞服务，影响性能
  - 惰性删除：每次获取key时，检查是否过期，过期则删除
    - 优点：不会阻塞服务，对CPU友好
    - 缺点：可能会有大量的过期键值对没有及时删除，占用内存
  - 定期删除：每隔一段时间，随机抽取一些key，检查是否过期，过期则删除
    - 优点：很少阻塞服务，也可以删除一部分过期键值对
    - 缺点：可能会有一些过期键值对没有及时删除，难以兼顾性能和内存
- Redis使用惰性删除和定期删除相结合的方式，保证了性能和内存的平衡。
- Redis的过期删除策略：定期删除+惰性删除的混合策略。
  - 惰性删除：每次获取key时，检查是否过期，过期则删除，可选同步或异步删除
  - 定期删除：每隔一段时间，随机抽取20个key，检查是否过期，过期则删除；如果删除的key超过25%，则重复上述步骤。定期删除的时间间隔由`hz`配置项决定，默认为10，即每秒执行10次。此外，为了避免发生循环循环过度，Redis会限制定期删除的执行时长，如果超过25ms，则会停止执行，等待下一次执行。

## 内存淘汰策略

当Redis的内存使用达到上限时，需要有相应的机制释放内存，即为内存淘汰策略。

配置文件中的`maxmemory`配置项用于设置Redis的最大内存限制，单位为字节。当内存使用达到上限时，Redis会根据`maxmemory-policy`配置项选择相应的内存淘汰策略。

- 内存淘汰策略
  - noeviction **(默认)**：默认策略，当内存使用达到上限时，如果有新的写操作，会报错禁止写入，不淘汰数据，查询和删除操作正常工作。
  - 在设置了过期时间的数据进行淘汰的策略
    - volate-random：随机淘汰过期数据
    - volatile-ttl：淘汰剩余时间最短的数据
    - volatile-lru：淘汰最近最少使用的数据
    - volatile-lfu：淘汰最少使用的数据
  - 在所有数据范围内进行淘汰的策略
    - allkeys-random：随机淘汰数据
    - allkeys-lru：淘汰最近最少使用的数据
    - allkeys-lfu：淘汰最少使用的数据
