# 主从架构

## 主从复制

Redis支持主从复制，主节点负责读写操作，从节点负责读操作，提高了读写性能和数据冗余。  
主服务器发生写操作时，会将写操作同步到从服务器，从服务器接收到写操作后，会执行写操作，保持数据一致。

- 第一次同步
   1. 建立链接
      1. 从服务器执行`slaveof` / `replicaof`命令，把自己设置为从服务器
      2. 从服务器向主服务器发送`PSYNC`命令，请求数据同步
          - `psync`命令参数
            - `runid`：主服务器的运行ID，第一次运行时为`?`
            - `offset`：主服务器的复制进度，第一次运行时为`-1`
      3. 主服务器接收到`PSYNC`命令，响应命令
          - `fullresync`：全量同步，主服务器发送RDB快照文件给从服务器
            - 此命令带上主服务器的运行ID和复制进度
   2. 同步数据
      1. 主服务器执行`bgsave`命令，生成RDB快照文件
      2. 主服务器将RDB快照文件发送给从服务器
      3. 从服务器清空数据，加载RDB快照文件
      > 同步数据过程中，生成快照文件后的写操作无法经过快照文件同步到从服务器
      > 为了解决这个问题，主服务器在生成快照文件，发送快照，从服务器加载快照的过程中，会记录主服务器的写操作，这些记录会写在replication buffer中，当从服务器加载完快照后，会将replication buffer中的写操作命令发送给从服务器，从服务器执行这些写操作，保证数据一致。
   3. 增量同步
      1. 从服务器完成全量同步后，向主服务器回复一个确认信息
      2. 主服务器接收到确认信息后，将写操作发送给从服务器
      3. 从服务器接收到写操作后，执行写操作，保持数据一致

- 命令传播
  主从服务器在完成第一次同步之后，双方会维护一个TCP连接。此连接是长连接，避免频繁的TCP连接和断开带来的性能开销。

- 分摊主服务器的压力
   从服务器也可以作为主服务器，充当一个中继器的功能。当有新的从服务器连接时，它可以连接从服务器，从服务器充当主服务器，将数据同步给新的从服务器。

- 增量复制
   当发生网络中断时，主从服务器之间的数据同步会中断。为了保证数据一致，恢复网络后，从服务器会重新连接主服务器，请求增量复制，主服务器会将断开连接期间的写操作发送给从服务器，保证数据一致。
   1. 从服务器向主服务器发送`PSYNC`命令，请求增量复制，此时offset为断开连接时的复制进度
   2. 主服务器接收到`PSYNC`命令，响应命令`CONTINUE`，告知采取使用增量复制
   3. 主服务器将短线期间的写命令发送给从服务器。从服务器接收到写操作后，执行写操作，保持数据一致
    > 增量复制的实现原理是主服务器维护一个复制缓冲区，记录主服务器的写操作，当从服务器请求增量复制时，主服务器将复制缓冲区中的写操作发送给从服务器，从服务器执行这些写操作，保持数据一致。
    > 具体细节如下：
    > 1. 在主从断连后，主服务器维护一个复制缓冲区`repl_backlog_buffer`，记录主服务器的写操作
    > 2. 于此同时，主服务器维护一个偏移量`master_repl_offset`，记录主服务器的复制进度，从服务器的复制进度为`slave_repl_offset`。
    > 3. 从服务器重连时，向主服务器发送`PSYNC`命令，带上自己的复制进度`slave_repl_offset`，主服务器接收到`PSYNC`命令后，判断`slave_repl_offset`是否在复制缓冲区中，如果在，可以进行增量复制。
    > 4. 如果不在，主服务器会发送`FULLRESYNC`命令，进行全量同步。

## 哨兵机制

Redis的主从复制存在单点故障，当主服务器宕机时，整个系统不可用。为了解决这个问题，Redis引入了哨兵机制，实现主从切换和故障恢复。

- 哨兵机制
  - 哨兵是一个独立的进程，负责监控主从服务器的状态，当主服务器宕机时，哨兵会选举一个从服务器作为新的主服务器，保证系统的可用性。
  - 哨兵的工作流程
    1. 哨兵监控主服务器的状态，当主服务器宕机时，哨兵会选举一个从服务器作为新的主服务器
        - 哨兵每隔1秒向所有服务器发送`PING`命令，各节点返回`PONG`命令，哨兵判断节点是否存活
        - 如果在`down-after-milliseconds`时间内，服务器没有返回`PONG`命令，哨兵认为服务器宕机，即主观下线
        - 为了减少误判，哨兵一般会部署多个节点，当多个哨兵都认为服务器宕机时，才会认为服务器真正宕机，即客观下线
           > 投票机制：当哨兵发现主服务器宕机时，会向其他哨兵发送`SENTINEL is-master-down-by-addr`命令，请求其他哨兵投票，如果超过`quorum`的哨兵认为主服务器宕机，则主服务器宕机
           > `quorum`：投票数，一般为哨兵节点数的一半加1
    2. 哨兵会通知所有的从服务器，切换到新的主服务器
        - 第一个判断主节点下线的哨兵收到`quorum`托票数将主节点客观下线之后，其自身转换为候选者，开始选举新的主节点
        - 候选者向其他哨兵发出命令，表示希望成为leader；其他哨兵收到命令后开始投票，每个哨兵只有一次投票机会，并且候选者只能投给自己。
        - 候选者收到至少`quorum`的投票，并且拿到超过所有哨兵节点数一半的投票数，就会成为新的leader
        - 由于投票机制，哨兵集群至少需要三个哨兵节点，才能保证一定能选出leader
        - 如果哨兵故障数量过多，则需要人为干预。
    3. 哨兵会通知客户端，主服务器发生了变化 **主从故障转移**
        1. 在原主节点的从节点中选举一个新的主节点
           1. 首先排除网络状态差的从节点。如果发生断连的次数超过10次，就会被排除
           2. 根据优先度排序，优先度在`slave-priority`配置项中设置，值越小优先级越高
           3. 再根据复制偏移量排序，即比较`slave-repl-offset`，值越大优先级越高
           4. 最后根据节点ID排序
           5. 选举出一个新的主节点后，哨兵Leader会向该节点发送`SLAVEOF no one`命令，让其成为新的主节点
           6. 当哨兵接收到的`INFO`变为`role:master`时，认为新的主节点选举成功
        2. 通知其他从节点切换到新的主节点
           1. 哨兵Leader向所有从节点发送`SLAVEOF new_master_ip new_master_port`命令，让其切换到新的主节点
        3. 通过发布订阅机制通知客户端，主服务器发生了变化
        4. 继续监视原主节点，当原主节点恢复时，将其设置为新的从节点
  - 哨兵的配置
    - `sentinel monitor`：监控主服务器的IP和端口
    - `sentinel down-after-milliseconds`：主服务器宕机后，哨兵等待多久才认为主服务器宕机
    - `sentinel failover-timeout`：主服务器宕机后，哨兵等待多久才进行故障转移
    - `sentinel parallel-syncs`：哨兵同时同步的从服务器数量
  - 哨兵的工作原理
    1. 哨兵监控主服务器的状态，当主服务器宕机时，哨兵会等待`down-after-milliseconds`时间，确认主服务器宕机
    2. 哨兵会选举一个从服务器作为新的主服务器
    3. 哨兵会通知所有的从服务器，切换到新的主服务器
    4. 哨兵会通知客户端，主服务器发生了变化
