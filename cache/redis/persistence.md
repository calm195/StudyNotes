# 持久化

Redis支持两种持久化方式：RDB快照和AOF日志。

## RDB快照

RDB快照是Redis的默认开启的持久化方式，将内存中的数据保存到磁盘上，生成一个快照文件。RDB快照是一个二进制文件，保存了某个时间点的全量数据。

- 触发方式
  - save命令：主动触发，在主线程中执行，可能会阻塞服务
  - bgsave命令：后台异步触发，在子线程中执行，不会阻塞服务
  - 配置文件：save m n，表示m秒内有n次写操作则触发bgsave
  - 信号：kill -15 pid，发送SIGTERM信号触发bgsave
  - 关闭服务：shutdown命令会触发bgsave
  - 主从同步：主节点执行bgsave，从节点会自动执行bgsave
- 执行bgsave过程中，主线程仍然可以继续处理操作命令。原理是写时复制技术。
  - 执行bgsave命令时，fork()命令创建子线程，此时子线程和主线程共享内存。
  - 发生修改内存数据时，会复制一份数据到子线程的内存中，主线程继续操作自己的内存数据。
  - 因此，快照保存过程中发生的数据修改不会体现在快照当中。

## AOF日志

AOF日志是Redis的另一种持久化方式，将写操作以追加的方式保存到AOF文件中。AOF日志是一个文本文件，保存了Redis的写操作。Redis先执行命令，然后再写入AOF日志中。
redis中默认不开启AOF，可以通过配置文件开启。redis.conf，如  

> ```txt
> appendonly    yes
> appendfilename "appendonly.aof"  
> appendfsync  写回策略，有三种
> ```

写入AOF日志的过程

1. Redis执行写操作命令
2. 把命令追加到`server.aof_buf`缓冲区
3. I/O系统调用write()，将`server.aof_buf`中的数据写入AOF文件，即拷贝到了内核缓冲区page cache
4. 内核将page cache中的数据写入硬盘

- 三种写回策略
  - always：每次写操作都会同步到磁盘，最安全但性能最差
  - everysec：每秒同步一次，折中方案
  - no：不主动同步，交给操作系统控制，性能最好但安全性最差

- **AOF重写机制**
  对于同一条数据，如果出现了多次写操作，以最新的数据作为结果写入新的AOF文件中。
  - 重写AOF是由后台**进程**`bgrewriteaof`完成的
    - 使用子进程是为了保证共享内存数据以只读的方式进行，如果发生了内存修改，那么就会发生写时复制。
    - 父子进程中各自拥有独立的数据副本，减少了加锁的性能消耗。
    - 主进程在AOF重写时执行的命令将追加到AOF重写缓冲区，重写子进程的工作完成后，将会通知主进程将AOF重写缓冲区中的数据追加到新的AOF文件中
    - 所有工作完成后，新的AOF文件改名，覆盖原有的AOF文件。
